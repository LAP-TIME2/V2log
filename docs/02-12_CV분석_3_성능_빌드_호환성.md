# V2log 성능/빌드/호환성 분석 — CV 기능 추가 관점

> 분석일: 2026-02-12 | 목적: CV 추가 시 성능 저하, 빌드 충돌, 플랫폼 호환성 문제 평가

---

## 1. 빌드 설정 분석

### Flutter/Dart 버전
```
Flutter: 3.38.7 (stable)
Dart SDK: 3.10.7
```
→ 최신 안정 버전. ML Kit, TFLite 완전 지원 ✅

### Android 설정

| 항목 | 값 | CV 요구사항 | 상태 |
|------|-----|-----------|------|
| Gradle 버전 | 8.14 | 8.0+ | ✅ 최신 |
| minSdkVersion | 21 (Flutter 기본값) | 21+ 필요 | ✅ 충족 |
| targetSdkVersion | 34 (Flutter 기본값) | 34+ 권장 | ✅ 충족 |
| Java/Kotlin | 17 / Kotlin | ML Kit 호환 | ✅ OK |
| NDK | flutter.ndkVersion | TFLite 필요 | ✅ 설정됨 |
| Core Library Desugaring | 2.0.4 | 호환성 향상 | ✅ 활성화 |

### iOS 설정

| 항목 | 상태 | 비고 |
|------|------|------|
| Podfile | ❌ 없음 | Flutter 자동 관리 |
| Info.plist | ✅ 존재 | 카메라 권한 **미설정** ⚠️ |
| NSPhotoLibraryAddUsageDescription | ✅ 있음 | 갤러리 저장용 |

---

## 2. 카메라 퍼미션 현황

### Android (AndroidManifest.xml)
```xml
현재 설정된 권한:
✅ POST_NOTIFICATIONS (알림)
✅ WRITE_EXTERNAL_STORAGE (안드로이드 9 이하)
❌ CAMERA 권한 없음 ← 추가 필요
```

### iOS (Info.plist)
```xml
❌ NSCameraUsageDescription 미설정 ← 추가 필요
```

---

## 3. 기존 패키지 분석

### 현재 의존성 (CV 관련)
```yaml
✅ flutter_riverpod: 2.5.1        # 상태 관리 OK
✅ supabase_flutter: 2.5.6        # 백엔드 OK
✅ fl_chart: 0.68.0               # 차트 OK (성능 최적화됨)
✅ rive: 0.13.4                   # 애니메이션 (고성능)
✅ lottie: 3.1.0                  # 애니메이션
✅ cached_network_image: 3.3.1    # 이미지 캐싱 OK
❌ camera                         # CV 추가 시 필요
❌ image                          # 이미지 처리
❌ google_mlkit_pose_detection    # ML 모델 필요
❌ tflite_flutter                 # 커스텀 모델 필요
❌ permission_handler             # 권한 관리 필요
```

**결론**: 카메라/ML 관련 패키지 0개 → 신규 추가 필요

---

## 4. 서비스 레이어 구조

### 현재 서비스
```
✅ supabase_service.dart          # Backend
✅ local_storage_service.dart     # Hive + SharedPreferences
✅ notification_service.dart      # 로컬 알림
```

### CV 추가 시
```
❌ camera_service.dart            # 신규 필요
❌ pose_detection_service.dart    # 신규 필요
❌ plate_detection_service.dart   # Phase 2에서 필요
```

**긍정적인 점**:
- 일관된 서비스 패턴 (싱글톤 + @riverpod)
- try-catch 에러 처리 규칙 준수
- 비동기 작업 체계화
- **새 서비스 추가가 기존 패턴을 그대로 따르면 됨** ✅

---

## 5. 성능 영향도 분석

### 현재 앱 크기/복잡도
```
총 Dart 코드: ~35,500줄
가장 큰 파일:
- stats_screen.dart: 1,933줄
- workout_screen.dart: 1,673줄
- user_provider.dart: 1,130줄
- history_screen.dart: 1,150줄
```

### 기존 애니메이션 오버헤드
```yaml
rive: 0.13.4       # SVG 근육 맵 → GPU 렌더링
lottie: 3.1.0      # 로티 애니메이션 → CPU/GPU
fl_chart: 0.68.0   # 통계 차트 → 렌더링 최적화됨
```

**현재 최적화 상태**:
- ✅ `AnimationConfig.staggerDelay()` 최대 10개 아이템만 애니메이션
- ✅ `TextScaler.noScaling` 적용
- ✅ `ListView.builder` 사용
- ⚠️ Rive는 24fps 이상에서 GPU 부하 증가 가능

### CV 추가 시 리소스 영향

| 구성 요소 | CPU | GPU | 메모리 | 배터리 |
|----------|-----|-----|--------|--------|
| MediaPipe Pose | 높음 | 중간 | 100-150MB | 높음 |
| 카메라 스트림 | 낮음 | 높음 | 50-80MB | 중간 |
| TFLite (Phase 2) | 매우높음 | 높음 | 200-300MB | 매우높음 |
| UI 업데이트 | 낮음 | 중간 | 50MB | 낮음 |

**예상 메모리 사용량**:
- 현재: ~150-200MB
- CV 추가 후: ~300-500MB
- **8GB 이상 기기 권장**

---

## 6. 플랫폼 호환성 체크

### Android

| 항목 | 요구사항 | 현재 | 상태 |
|------|--------|------|------|
| minSdk | 21+ | 21 | ✅ |
| MediaPipe | 21+ | 21 | ✅ |
| TFLite | 21+ | 21 | ✅ |
| CAMERA 권한 | 필수 | 미설정 | ⚠️ 추가 필요 |

### iOS

| 항목 | 요구사항 | 현재 | 상태 |
|------|--------|------|------|
| Deployment Target | 13.0+ | 기본값 | ✅ 확인 필요 |
| NSCameraUsageDescription | 필수 | 미설정 | ⚠️ 추가 필수 |
| CoreML | 13.0+ | - | ✅ |
| Metal (GPU) | 13.0+ | - | ✅ |

---

## 7. 예상 문제점 및 대응

### 🔴 High Priority

**1. 메모리 부족 (저사양 기기)**
- 현상: 6GB 미만 기기에서 OOM 발생 가능
- 대응:
  - 카메라 해상도 낮춤 (720p → 480p)
  - MediaPipe 경량 모델 사용
  - Riverpod keepAlive 정책 재검토

**2. 배터리 소모**
- 현상: CV 30분에 20-30% 배터리 감소
- 대응:
  - 프레임 스킵 (1초에 2-3프레임만 처리)
  - 상태 미변화 감지 시 자동 중단
  - 쉬는 시간 AI 중지

**3. 권한 추가**
- Android: `<uses-permission android:name="android.permission.CAMERA"/>`
- iOS: `NSCameraUsageDescription` 추가

### 🟡 Medium Priority

**4. 프레임 드롭 (UI 버벅임)**
- 대응: Isolate 분리 처리
```dart
Future<PoseResult> _processPoseInIsolate(CameraImage image) {
  return compute(_poseDetection, image);
}
```

**5. 카메라 초기화 시간 (2-3초 지연)**
- 대응: 카메라 사전 초기화 또는 비동기 로딩 UI

**6. 모델 용량**
- MediaPipe MoveNet: ~8MB
- YOLOv8/11 (Phase 2): ~50-200MB

---

## 8. 구현 전 체크리스트

### 플랫폼 설정
- [ ] Android `<uses-permission android:name="android.permission.CAMERA"/>`
- [ ] iOS `NSCameraUsageDescription` 추가
- [ ] iOS Minimum Deployment Target 13.0+ 확인
- [ ] Android minSdkVersion 21 확인

### 패키지 추가
- [ ] camera: ^0.10.6
- [ ] google_mlkit_pose_detection: ^0.11.0
- [ ] permission_handler: ^11.4.0
- [ ] (Phase 2) tflite_flutter: ^0.10.4
- [ ] (Phase 2) image: ^4.1.0

### 성능 최적화
- [ ] 카메라 해상도 최대 720p
- [ ] 프레임 스킵 (2~3번째만 처리)
- [ ] Isolate 분리 (ML 추론)
- [ ] 메모리 프로파일링 (DevTools)

### 배터리 관리
- [ ] CV 활성화 시에만 카메라 켜기 (토글)
- [ ] 쉬는 시간 자동 중지
- [ ] 화면 꺼짐 감지

---

## 9. 최종 평가

### 종합 점수: 7.5/10 ✅ CV 추가 가능

| 항목 | 점수 | 평가 |
|------|------|------|
| 빌드 설정 | 9/10 | 매우 안정적, 최신 버전 |
| 권한 관리 | 5/10 | 카메라 권한 추가 필요 |
| 서비스 레이어 | 9/10 | 확장성 높음, 패턴 일관 |
| 성능 여유도 | 6/10 | 저사양 기기 주의 필요 |
| 아키텍처 호환성 | 8/10 | 거의 완벽 |

### 결론

**V2log는 CV 기능 추가에 기술적으로 준비된 상태.**

해결할 3가지:
1. **권한 설정** (Android + iOS) — 간단
2. **저사양 기기 메모리 최적화** (프레임 스킵, 해상도 조정) — 중간
3. **배터리 관리** (선택적 활성화, 자동 중단) — 중간

기존 Riverpod + 서비스 레이어 패턴이 견고해서 새 서비스 추가가 매우 용이. **앱을 새로 만들 필요 없음.** ✅
