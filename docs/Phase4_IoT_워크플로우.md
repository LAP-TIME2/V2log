# Phase 4: Fica IoT 개발 워크플로우

> **문서 버전**: v1.1
> **작성일**: 2026-02-22 (v1.1 결정 사항 5건 반영)
> **기술 상세**: `docs/reference/02-21_피카_피트니스카운터_종합개발가이드.md` (1,666줄)
> **SSOT**: 이 문서가 Phase 4 진행 추적의 유일한 소스

---

## 1. 프로젝트 개요

### 1.1 핵심 목표

Fica(피카) 피트니스 카운터 — IMU 센서 + BLE 컨트롤러 + NFC 기반 자동 횟수 카운팅 + 기구 사용시간 컨트롤 IoT 디바이스

### 1.2 12주 타임라인

| Phase | 기간 | 핵심 작업 |
|-------|------|----------|
| **Phase A** | 1~2주 | BLE GATT 프로토콜 확정, DB 스키마, 회로도 초안, 부품 발주 |
| **Phase B** | 3~6주 | IMU 드라이버 + 카운팅, 앱 BLE 연동, LED/버튼/진동, 브레드보드 프로토타입 |
| **Phase C** | 7~9주 | 펌웨어↔앱 통합, PCB 수령, 케이스 조립, 헬스장 실기기 테스트 |
| **Phase D** | 10~12주 | 배터리 최적화, B2B 대시보드, 사용시간 컨트롤, 양산 준비 |

### 1.3 의존 관계

```
              Team 1: BLE 프로토콜 (1~2주) ← 크리티컬 패스
             ╱        |         ╲
            ▼          ▼           ▼
Team 3: H/W → Team 2: 펌웨어    Team 4: 앱 연동 → Team 5: 백엔드
                ╲                     ╱
                 [통합 테스트 + 헬스장 검증]
```

### 1.4 역할 분담

| 역할 | 담당자 | 범위 |
|------|--------|------|
| **소프트웨어 (BLE/앱/백엔드)** | Claude + 사용자 | Team 1, 4, 5 |
| **펌웨어 개발** | Kmong 프리랜서 | Team 2 (Claude가 스펙 작성) |
| **하드웨어 설계** | Kmong 프리랜서 | Team 3 (Claude가 검증) |
| **의사결정 + 테스트** | 사용자 | 전체 |

---

## 2. 에이전트 팀 구성 (5팀 × 7단계)

### 7단계 워크플로우 (각 팀 공통)

| # | 단계 | 설명 |
|---|------|------|
| 1 | 조사 (Research) | 기술 조사, 선행 사례, 공식 문서 |
| 2 | 계획 (Plan) | 설계 문서, 인터페이스 정의 |
| 3 | 구현/테스트 (Build) | 코드 작성 또는 하드웨어 제작 |
| 4 | 검증 (Verify) | 단위 테스트, 크로스체크 |
| 5 | 비판 (Critique) | 엣지 케이스, 보안, 성능 리뷰 |
| 6 | 피드백 (Feedback) | 사용자/테스터 피드백 수집 |
| 7 | 수정보완 (Refine) | 피드백 반영, 최종 산출물 |

---

### Team 1: BLE 프로토콜 설계 — 🔴 크리티컬 패스

> **담당**: Claude + 사용자
> **기간**: Phase A (1~2주)
> **블로커**: 없음 (첫 출발점)
> **의존**: Team 2, 4가 이 결과에 의존

**산출물**: `docs/ble-gatt-spec.md` — GATT 프로파일 + 패킷 구조 + 연결 흐름

| # | 단계 | 작업 내용 | 완료 기준 |
|---|------|----------|----------|
| 1 | 조사 | BLE 5.0 GATT 설계 패턴, 유사 제품(GymAware, Enode) 프로토콜 분석 | 조사 보고서 |
| 2 | 계획 | GATT Service/Characteristic UUID, 패킷 바이트 구조, Command 코드 정의 | 스펙 초안 |
| 3 | 구현 | `docs/ble-gatt-spec.md` 문서 확정 + Flutter mock 서비스 | 문서 + 코드 |
| 4 | 검증 | Session Data 패킷 인코딩/디코딩 유닛 테스트 | 테스트 통과 |
| 5 | 비판 | 패킷 크기(MTU 제한), 재연결 시나리오, 보안(Just Works vs MITM) 리뷰 | 리뷰 문서 |
| 6 | 피드백 | 사용자 검토 — 무게 0.1kg 단위, 세트 최대 10개 등 UX 확인 | 승인 |
| 7 | 수정보완 | 피드백 반영 + 최종 스펙 확정 | v1.0 확정 |

---

### Team 2: 임베디드 펌웨어 — 프리랜서 위탁

> **담당**: Claude(스펙 작성) → 프리랜서(구현)
> **기간**: Phase B~C (3~9주)
> **블로커**: Team 1 완료 (GATT 스펙 필요)
> **산출물**: `docs/firmware-spec.md` + `docs/kmong/firmware-brief.md`

| # | 단계 | 작업 내용 | 완료 기준 |
|---|------|----------|----------|
| 1 | 조사 | Zephyr RTOS + nRF52840 + IMU 드라이버 패턴, 기존 카운팅 알고리즘(rep_counter_service.dart) 이식 가능성 | 조사 노트 |
| 2 | 계획 | 펌웨어 요구사항 명세서 (`firmware-spec.md`) — 모듈 구조, 상태 머신, 알고리즘 인터페이스 | 스펙 완성 |
| 3 | 구현 | Kmong 브리프 작성 → 프리랜서 계약 → 프리랜서가 코드 구현 | 코드 수령 |
| 4 | 검증 | Claude가 코드 리뷰 — GATT 스펙 준수, 메모리/전력 체크 | 리뷰 통과 |
| 5 | 비판 | 안전바 오카운팅, BLE 끊김 복구, FIFO 오버플로우, 배터리 수명 분석 | 이슈 리스트 |
| 6 | 피드백 | DK 데모 → 사용자 실제 바이셉컬 테스트 | 80%+ 정확도 |
| 7 | 수정보완 | 이슈 수정 + 정확도 튜닝 + 최종 빌드 | v1.0 릴리즈 |

---

### Team 3: 하드웨어 설계 — 프리랜서 위탁

> **담당**: Claude(스펙/검증) → 프리랜서(PCB/케이스)
> **기간**: Phase A~C (1~9주)
> **블로커**: 부품 배송 (1~2주) — 센서 모델 ICM-45686 확정 완료
> **산출물**: `docs/hardware-spec.md` + `docs/kmong/hardware-brief.md`

| # | 단계 | 작업 내용 | 완료 기준 |
|---|------|----------|----------|
| 1 | 조사 | nRF52840 모듈(MDBT50Q), IMU 풋프린트, PCB 안테나 설계 패턴 | 조사 노트 |
| 2 | 계획 | 회로도 초안 + 핀 할당표 + PCB 레이아웃 가이드 (`hardware-spec.md`) | 스펙 완성 |
| 3 | 구현 | Kmong 브리프 → 프리랜서가 KiCad/Altium 회로도 + PCB + 3D 케이스 | Gerber 파일 수령 |
| 4 | 검증 | Claude가 DRC(Design Rule Check) 결과 리뷰 + BOM 크로스체크 | 리뷰 통과 |
| 5 | 비판 | BLE 안테나 성능, 전원 노이즈, IMU 진동 격리, IPX4 방수 | 이슈 리스트 |
| 6 | 피드백 | JLCPCB 발주 → 수령 → 조립 → 동작 테스트 | 전원 ON + BLE 광고 |
| 7 | 수정보완 | PCB Rev.2 수정 (있으면) + 케이스 핏 조정 | 최종 하드웨어 |

---

### Team 4: 앱 연동 (Flutter) — Claude + 사용자

> **담당**: Claude + 사용자
> **기간**: Phase A~B (1~6주)
> **블로커**: Team 1 완료 (GATT UUID 필요)
> **산출물**: Flutter BLE/NFC 서비스 + UI

| # | 단계 | 작업 내용 | 완료 기준 |
|---|------|----------|----------|
| 1 | 조사 | flutter_blue_plus API, nfc_manager API, 기존 V2log 아키텍처 분석 | 조사 노트 |
| 2 | 계획 | FicaBleService, NfcService, FicaController 인터페이스 설계 | 설계 문서 |
| 3 | 구현 | BLE 연동 + NFC 읽기 + Fica 전용 UI (무게 표시, 횟수 실시간, 세트 LED 미러링) | 코드 완성 |
| 4 | 검증 | Mock BLE 데이터로 UI 동작 확인 + 실 기기(R3CN90HVMKL) 빌드 | 빌드 성공 |
| 5 | 비판 | BLE 끊김 UX, NFC 실패 폴백, 배터리 경고, 오프라인 모드 | 리뷰 |
| 6 | 피드백 | DK 보드 실제 BLE 연결 → 데이터 송수신 | 실기기 동작 |
| 7 | 수정보완 | 피드백 반영 + 성능 최적화 | v1.0 |

---

### Team 5: 백엔드 + B2B — Claude + 사용자

> **담당**: Claude + 사용자
> **기간**: Phase B~D (3~12주)
> **블로커**: Team 1 (데이터 구조) + Team 4 (모델 확정)
> **산출물**: `docs/db-schema-iot.md` + Supabase DDL + B2B 대시보드

| # | 단계 | 작업 내용 | 완료 기준 |
|---|------|----------|----------|
| 1 | 조사 | Supabase RLS 정책, B2B SaaS 대시보드 패턴, 기구 대기열 시스템 | 조사 노트 |
| 2 | 계획 | IoT DB 스키마 설계 (gyms, equipment, equipment_usage, equipment_queue) | `db-schema-iot.md` |
| 3 | 구현 | Supabase DDL 실행 + RLS 정책 + B2B 대시보드 MVP (기구 회전율, 사용 통계) | 스키마 + 대시보드 |
| 4 | 검증 | INSERT/SELECT/UPDATE 테스트 + RLS 권한 체크 | 테스트 통과 |
| 5 | 비판 | 동시 사용자 충돌 (기구 점유 레이스 컨디션), 데이터 정합성, 백업 전략 | 리뷰 |
| 6 | 피드백 | 프로토타입 필드 테스트 데이터로 대시보드 검증 | 대시보드 동작 |
| 7 | 수정보완 | 피드백 반영 + 성능 인덱스 + B2B 기능 확장 | v1.0 |

---

## 3. 마일스톤 체크리스트 (M1~M7)

### M1: DK 데모 (2주차)

> BLE로 더미 횟수 데이터를 앱에 표시

- [x] BLE GATT 스펙 문서 v1.0 확정 (`docs/ble-gatt-spec.md`)
- [ ] nRF52840-DK 구매 + Zephyr 환경 구축
- [ ] DK에서 BLE 광고("Fica-XXXX") 성공
- [ ] Flutter 앱에서 BLE 스캔 + 연결 성공
- [ ] 더미 횟수 데이터 Notify → 앱 UI 표시
- [ ] Session Data 패킷 인코딩/디코딩 테스트 통과

### M2: 센서 데모 (3주차)

> 바이셉 컬 80%+ 정확도 달성

- [ ] IMU 평가보드 수령 + SPI 연결
- [ ] 카운팅 알고리즘 DK 이식 (Peak Detection + Velocity Gate)
- [ ] 바이셉 컬 80%+ 정확도 (10세트 테스트)
- [ ] BLE로 실시간 횟수 → 앱 표시

### M3: 브레드보드 통합 (4주차)

> 전체 부품 동작 확인 (LED + 버튼 + 진동 + BLE + NFC)

- [ ] TM1637 + 7-세그먼트 LED 숫자 표시 (P0.11 CLK, P0.12 DIO)
- [ ] 세트 LED 10개 (74HC595 ×3 + 2색 LED 초록/빨강) 개별 제어
- [ ] +/- 버튼 입력 → 무게 조정
- [ ] 진동 모터 PWM 제어
- [ ] NFC 태그 읽기 → 기구 ID 인식
- [ ] 전체 STEP 0~6 브레드보드 데모

### M4: 헬스장 1차 테스트 (4주차)

> 3종 운동 85%+ 정확도

- [ ] 바이셉 컬 85%+ (센서 부착 테스트)
- [ ] 레그 익스텐션 85%+ (핀 로드 머신)
- [ ] 45° 레그프레스 85%+ (플레이트 로드)
- [ ] 안전바 해제 동작 오카운팅 0건
- [ ] BLE 연결 안정성 (30분 연속 유지)

### M5: PCB 프로토타입 (8주차)

> 실물 5대 조립 완료

- [ ] PCB Gerber 파일 + BOM 확정
- [ ] JLCPCB 발주 + 수령
- [ ] SMD 부품 납땜 + 조립
- [ ] 3D 프린팅 케이스 (SLA 레진)
- [ ] 자석 마운트 + IPX4 방수 확인
- [ ] 5대 전체 전원 ON + BLE 광고 성공

### M6: 필드 테스트 (10주차)

> 2주간 실제 헬스장 운영

- [ ] 헬스장 기구 5대에 센서 설치
- [ ] NFC 태그 10개 부착 + 앱 매핑
- [ ] 일반 사용자 3명 2주 테스트
- [ ] 기구 사용시간 컨트롤 동작 확인
- [ ] 배터리 수명 실측 (목표: 10일+)

### M7: 양산 준비 (12주차)

> BOM 확정 + 인증 서류 준비

- [ ] 양산 BOM 확정 (목표: 대당 37,000원 이하)
- [ ] OTA 펌웨어 업데이트 동작 확인
- [ ] B2B 대시보드 MVP (기구 회전율, 사용 통계)
- [ ] 사용 매뉴얼 작성
- [ ] KC/전파 인증 서류 준비
- [ ] 양산 업체(OEM) 선정 + 샘플 발주

---

## 4. 팀별 진행 대시보드

> 상태 기호: ⬜ 미시작 / 🔄 진행중 / ✅ 완료 / ⏸️ 대기 / ❌ 재작업

### Team 1: BLE 프로토콜 (크리티컬 패스)

| 단계 | 상태 | 날짜 | 산출물 |
|------|------|------|--------|
| 1. 조사 | ✅ | 02-21 | BLE 5.0 GATT 패턴 + 유사 제품 분석 |
| 2. 계획 | ✅ | 02-21 | `docs/ble-gatt-spec.md` v1.0 (981줄) |
| 3. 구현 | ✅ | 02-21 | GATT 스펙 문서 확정 (12 Char + 3 Service) |
| 4. 검증 | ✅ | 02-21 | UUID 연속성 + 패킷 인코딩/디코딩 일치 + MTU 확인 |
| 5. 비판 | ⬜ | — | — |
| 6. 피드백 | ⬜ | — | — |
| 7. 수정보완 | ⬜ | — | — |

### Team 2: 임베디드 펌웨어 (프리랜서)

| 단계 | 상태 | 날짜 | 산출물 |
|------|------|------|--------|
| 1. 조사 | ⬜ | — | — |
| 2. 계획 | ⬜ | — | — |
| 3. 구현 | ⬜ | — | — |
| 4. 검증 | ⬜ | — | — |
| 5. 비판 | ⬜ | — | — |
| 6. 피드백 | ⬜ | — | — |
| 7. 수정보완 | ⬜ | — | — |

### Team 3: 하드웨어 설계 (프리랜서)

| 단계 | 상태 | 날짜 | 산출물 |
|------|------|------|--------|
| 1. 조사 | ⬜ | — | — |
| 2. 계획 | ⬜ | — | — |
| 3. 구현 | ⬜ | — | — |
| 4. 검증 | ⬜ | — | — |
| 5. 비판 | ⬜ | — | — |
| 6. 피드백 | ⬜ | — | — |
| 7. 수정보완 | ⬜ | — | — |

### Team 4: 앱 연동 Flutter

| 단계 | 상태 | 날짜 | 산출물 |
|------|------|------|--------|
| 1. 조사 | ⬜ | — | — |
| 2. 계획 | ⬜ | — | — |
| 3. 구현 | ⬜ | — | — |
| 4. 검증 | ⬜ | — | — |
| 5. 비판 | ⬜ | — | — |
| 6. 피드백 | ⬜ | — | — |
| 7. 수정보완 | ⬜ | — | — |

### Team 5: 백엔드 + B2B

| 단계 | 상태 | 날짜 | 산출물 |
|------|------|------|--------|
| 1. 조사 | ⬜ | — | — |
| 2. 계획 | ⬜ | — | — |
| 3. 구현 | ⬜ | — | — |
| 4. 검증 | ⬜ | — | — |
| 5. 비판 | ⬜ | — | — |
| 6. 피드백 | ⬜ | — | — |
| 7. 수정보완 | ⬜ | — | — |

---

## 5. 프리랜서 위탁 (Kmong)

### 5.1 펌웨어 개발자 공고

**제목**: [nRF52840 + Zephyr] 피트니스 IoT 센서 펌웨어 개발

**예산**: 200~400만 원 (협의 가능)

**기간**: 6~8주

**필수 역량**:
- nRF52840 (또는 nRF52 시리즈) 펌웨어 개발 경험
- Zephyr RTOS 프로젝트 경험 (nRF Connect SDK)
- SPI/I2C 센서 드라이버 작성 경험
- BLE GATT 서비스 구현 경험
- C 언어 능숙

**우대 역량**:
- IMU 센서 (ICM-45686, LSM6DSV, BMI270 등) 경험
- 저전력 설계 (Sleep mode, WOM)
- OTA DFU 구현 경험
- TM1637/74HC595 드라이버 경험

**업무 범위** (8개):
1. IMU 센서 (ICM-45686) SPI 드라이버 개발 (FIFO 읽기, 캘리브레이션)
2. 횟수 카운팅 알고리즘 구현 (Peak Detection + Velocity Gate + Confirmation System)
3. BLE GATT 서비스 구현 (GATT 스펙 문서 제공, Rep=실시간 Notify + Session=Indicate)
4. 7-세그먼트 LED 제어 (TM1637, GPIO bit-bang 2핀)
5. 세트 LED 제어 (74HC595 ×3 + 2색 LED 초록/빨강 10개, 20비트)
6. 버튼 입력 + 진동 모터 PWM 제어
7. NFC 태그 읽기/쓰기 (NT3H2111, I2C)
8. 저전력 모드 + 배터리 관리 + OTA DFU

**제공 자료**:
- BLE GATT 스펙 문서 (`ble-gatt-spec.md`)
- 카운팅 알고리즘 레퍼런스 코드 (Dart → C 이식 가이드)
- 핀 할당표 + 회로도
- 시스템 상태 머신 다이어그램 (STEP 0~6)
- V2log 앱 BLE 연동 코드 (프로토콜 테스트용)

---

### 5.2 하드웨어 설계자 공고

**제목**: [nRF52840 + IMU] 피트니스 IoT 센서 PCB + 케이스 설계

**예산**: 100~200만 원 (협의 가능)

**기간**: 4~6주

**필수 역량**:
- KiCad 또는 Altium Designer PCB 설계 경험
- BLE 안테나 매칭 / RF 레이아웃 경험
- 3D CAD (Fusion 360, SolidWorks 등) 케이스 설계
- SMD 납땜 또는 조립 대행 경험

**우대 역량**:
- nRF52840 / BLE 모듈 PCB 설계 경험
- 방수 (IPX4) 설계 경험
- SLA/FDM 3D 프린팅 시제품 제작 경험

**업무 범위** (6개):
1. 회로도 설계 (nRF52840 모듈 + ICM-45686 + TM1637 + 74HC595 ×3 + 2색 LED + TP4056 + NFC)
2. PCB 레이아웃 (70×40mm, 2레이어, BLE 안테나 영역 확보)
3. Gerber 파일 + BOM 생성 → JLCPCB 발주
4. 3D 케이스 설계 (80×50×20mm, 네오디뮴 자석 마운트, USB-C, 버튼 홀)
5. IPX4 방수 설계 (실리콘 가스켓 + 버튼 커버)
6. 시제품 5대 조립 (PCB + 케이스 + 배터리)

**제공 자료**:
- 핀 할당표 (종합 개발 가이드 §5.2.9)
- PCB 레이아웃 가이드 (§5.2.10)
- 케이스 외형 설계 (§5.2.11)
- BOM 초안 (§6.1~6.3)

---

### 5.3 프리랜서 검색 키워드

Kmong/크몽에서 아래 키워드로 프리랜서 검색:

**펌웨어**:
- "nRF52840 펌웨어"
- "Zephyr RTOS"
- "BLE 펌웨어 개발"
- "IMU 센서 드라이버"
- "nRF Connect SDK"

**하드웨어**:
- "PCB 설계 KiCad"
- "BLE 안테나 PCB"
- "3D 프린팅 케이스 설계"
- "IoT 하드웨어 시제품"
- "SMD 납땜 조립"

---

## 6. 결정 사항 (MEMORY.md 연동)

> 📌 = 미결정, ✅ = 확정 — **5건 전원 확정 (02-22)**

| # | 항목 | 상태 | 확정 내용 | 비고 | 확정일 |
|---|------|------|----------|------|--------|
| 1 | 센서 모델 | ✅ | **ICM-45686** | 프로토 3대 → 양산 시 LSM6DSV 재검토 | 02-22 |
| 2 | 총 세트 수 입력 위치 | ✅ | **앱에서 설정 → BLE 전송** | 컨트롤러는 수신만 | 02-22 |
| 3 | 횟수 동기화 방식 | ✅ | **Rep=실시간 Notify + Session=완료 후 Indicate** | 하이브리드 방식 (실시간 UX + 세션 정합성) | 02-22 |
| 4 | 7-seg 드라이버 IC | ✅ | **TM1637** (GPIO bit-bang 2핀) | P0.11 CLK, P0.12 DIO | 02-22 |
| 5 | 세트 LED 방식 | ✅ | **74HC595 ×3 + 2색 LED(초록/빨강) 10개** (20비트) | (옵션) 전원 파란 LED 1개 추가 | 02-22 |

---

## 7. 참조 문서 인덱스

| 문서 | 경로 | 내용 |
|------|------|------|
| 종합 개발 가이드 (1,666줄) | `docs/reference/02-21_피카_피트니스카운터_종합개발가이드.md` | 8개 챕터 기술 상세 |
| 하드웨어 센서 실현가능성 보고서 | `docs/reference/02-20_하드웨어센서_횟수카운팅_실현가능성_조사보고서.md` | 기존 제품 8개 비교 |
| IMU 4종 비교 분석 | `docs/reference/02-20_IMU센서_4종_비교분석_보고서.md` | ICM-45686 1순위 |
| 45° 레그프레스 IMU 분석 | `docs/reference/02-20_45도_플레이트로드_레그프레스_IMU_분석.md` | 예상 정확도 93~96% |
| 사업계획서 ICM-45686 | `docs/reference/02-20_2026_사업계획서_ICM45686.md` | 성능 최적화 버전 |
| 사업계획서 LSM6DSV | `docs/reference/02-20_2026_사업계획서_LSM6DSV.md` | 가격 최적화 버전 |
| 사업계획서 Fica 2025 | `docs/reference/CV_피벗_사업계획서_Fica_2026.md` | 2025 베이스 |
| BLE GATT 스펙 v1.0 | `docs/ble-gatt-spec.md` | GATT 프로파일 + 패킷 구조 + 연결 흐름 (1,825줄) |
| BLE GATT 해설집 | `docs/ble-gatt-spec-해설집.md` | 비전공자용 해설 |
| DB 스키마 (기존 앱) | `docs/db-schema.md` | V2log 앱 DDL |

---

> **문서 끝**
> 진행 상황 업데이트: 체크박스(`- [x]`)와 대시보드 상태 기호 변경으로 추적.
> `/iot-status` 스킬로 자동 대시보드 출력 가능.
