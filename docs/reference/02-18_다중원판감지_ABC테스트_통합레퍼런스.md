# 다중 원판 감지 — A/B/C 테스트 + 데이터 보강 + 기술 조사 통합 레퍼런스

> 작성일: 2026-02-18 | 관련 문서 3개 통합 + A/B/C 구현 기록

---

## 1. 문제 정의

### 현재 상태
- **원판 1개**: mAP50 96.2% (정확)
- **원판 2개+ 겹침**: 전부 실패 (바깥 1장만 감지 → 무게 과소 추정)
- **원인**: 학습 데이터에 겹친 원판이 제대로 없고, 라벨링도 잘못됨

### 예시
| 실제 바벨 | AI 감지 | 실제 무게 | AI 추정 |
|----------|---------|----------|---------|
| 20kg×2 + 바벨 | 20kg×1 | **100kg** | 60kg |
| 10kg×2 + 바벨 | 10kg×1 | **60kg** | 40kg |
| 20kg+10kg + 바벨 | 20kg×1 | **80kg** | 60kg |

### 왜 안 되는가 (물리적 한계)
- **같은 클래스 겹침 (10+10)**: 정면에서 보면 1장이랑 2장이 **똑같이 생김**
- **다른 클래스 겹침 (20+10)**: 바깥 20kg 뒤로 10kg **테두리만** 살짝 보임
- 어떤 AI도 정면에서 "같은 원판이 몇 장 겹쳤는지"는 물리적으로 판별 불가

---

## 2. 세 가지 접근법 (외부 AI 제안)

### 2-1. Mode A: Bbox Aspect Ratio (ChatGPT 접근법)

**원리**: 대각선(20-45°)에서 원판이 2장이면 두께가 2배 → bbox가 더 두꺼운 타원

```
정면 (0°):     측면 (30°):
  ┌───┐          ┌─────┐
  │ O │  1장     │  O  │  1장 = 얇은 타원
  └───┘          └─────┘
  ┌───┐          ┌───────┐
  │ O │  2장     │  O O  │  2장 = 두꺼운 타원 (aspect ratio 증가)
  └───┘          └───────┘
```

**알고리즘**:
1. YOLO가 감지한 bbox의 `height / width` = aspect ratio 계산
2. 원판 종류별 "1장일 때 최대 aspect ratio" 상수와 비교
3. 초과분 / 두께비율 = 추정 장수

**원판 물리적 치수 (IWF 표준)**:

| 원판 | 직경 | 두께 | 1장 최대 aspect | 두께비율 |
|------|------|------|----------------|---------|
| 20kg | 450mm | 52mm | 1.15 | 0.116 |
| 15kg | 375mm | 45mm | 1.15 | 0.120 |
| 10kg | 290mm | 39mm | 1.15 | 0.134 |
| 5kg | 248mm | 27mm | 1.12 | 0.109 |
| 2.5kg | 213mm | 19mm | 1.10 | 0.089 |

**추가 모델/에셋**: 없음 (기존 YOLO만 사용)
**추가 처리시간**: ~0ms
**예상 정확도**: 정면 0° = **실패**, 30°+ = **40-60%**

---

### 2-2. Mode B: MiDaS Depth Estimation (Gemini 접근법)

**원리**: MiDaS v2.1 TFLite로 depth map 생성 → 원판 영역의 depth 분산으로 장수 추정

```
Depth Map 시각화:
  가까움(밝음) ←──→ 멀리(어두움)

  원판 1장:      원판 2장:
  ┌──────┐      ┌──────┐
  │██████│      │██▓▓██│  ← 경계에서 depth 단차
  │██████│      │██▓▓██│
  └──────┘      └──────┘
  depth 균일     depth 변동 큼
```

**알고리즘**:
1. YOLO 추론 (원판 위치) → MiDaS 추론 (depth map) 순차 실행
2. 원판 bbox 중앙 50% 영역의 depth 통계 (평균, 표준편차, 범위)
3. `normalizedRange = (max - min) / mean`
4. 범위별 장수 매핑: <0.15 = 1장, <0.30 = 2장, <0.45 = 3장

**MiDaS 모델 스펙**:
- 파일: `assets/models/midas_v2.tflite` (64MB)
- 출처: https://github.com/isl-org/MiDaS/releases/download/v2_1/model_opt.tflite
- 입력: `[1, H, W, 3]` float32 (H×W는 모델에 따라 256 또는 384, 코드에서 동적 대응)
- 출력: `[1, H, W]` float32 (relative inverse depth)
- 전처리: YUV→RGB → resize → ImageNet normalize `(pixel/255 - mean) / std`
  - mean = [0.485, 0.456, 0.406], std = [0.229, 0.224, 0.225]

**한계**: MiDaS = **relative** depth (절대 mm 변환 불가) → threshold 기반 heuristic, 실기기 튜닝 필수

**추가 에셋**: 64MB TFLite 모델
**추가 처리시간**: ~150-300ms
**예상 정확도**: 정면 = **20-40%**, 대각선 = **30-50%**

---

### 2-3. Mode C: Sobel Edge Projection (Genspark 접근법)

**원리**: YOLO bbox crop → Sobel 수평 에지 필터 → Y축 히스토그램 → 피크 수 = 원판 경계 수

```
원판 1장 edge projection:     원판 2장 edge projection:
  ▲                            ▲
  │  ╱╲                        │  ╱╲   ╱╲
  │ ╱  ╲                       │ ╱  ╲ ╱  ╲  ╱╲
  │╱    ╲                      │╱    ╲╱    ╲╱  ╲
  └──────→ Y                   └──────────────→ Y
  피크 2개 (상단+하단 rim)      피크 3-4개 (경계 추가)
```

**알고리즘**:
1. YOLO bbox → CameraImage Y채널에서 grayscale crop 추출
2. Sobel Y 커널 `[-1,-2,-1; 0,0,0; 1,2,1]` 적용 (수평 에지 강조)
3. 각 행의 에지 값 합산 → Y축 projection 생성
4. Gaussian smoothing (sigma=2.0)
5. 피크 검출 (local maxima, minDistance = cropH/8, threshold = max×30%)
6. 피크 수 → 장수: ≤2 = 1장, ≤4 = 2장, ≤6 = 3장, >6 = 노이즈→1장

**추가 모델/에셋**: 없음 (순수 Dart 수학 연산)
**추가 처리시간**: ~1ms
**예상 정확도**: 정면 = **0%**, 대각선 = **10-30%**, 메탈 반사 교란 가능

---

## 3. 예상 정확도 비교표

| 조건 | OFF (기존) | Mode A | Mode B | Mode C |
|------|-----------|--------|--------|--------|
| 1장, 정면 | 96% | 96% | 96% | 96% |
| 2장 같은무게, 정면 | 0% | **0%** | **20-40%** | **0%** |
| 2장 같은무게, 30° | 0% | **40-60%** | **30-50%** | **10-30%** |
| 2장 다른무게, 정면 | 0% | 0% | 10-20% | 0% |
| 구현 복잡도 | — | 낮음 | **높음** | 중간 |
| 추가 에셋 | — | 없음 | 64MB | 없음 |
| 추가 처리시간 | — | ~0ms | ~150-300ms | ~1ms |

**핵심 인사이트**: 정면(0°)에서는 3가지 모두 물리적 한계로 실패. 대각선(20-45°)에서만 의미.

---

## 4. 구현 아키텍처

### APK 2개 분리 (같은 코드, 다른 빌드)

```
┌─────────────────────────────────────────────────┐
│  CameraOverlay (Stage 1) — 모드 선택 버튼       │
│  APK 1: [OFF] [A] [C]                          │
│  APK 2: [OFF] [B]                              │
├─────────────────────────────────────────────────┤
│  WeightDetectionService                         │
│                                                 │
│  processFrame(CameraImage)                      │
│    └→ YOLO 추론 (공통)                          │
│    └→ _activeMode 분기:                         │
│         'none' → 기존 로직 (plate count = 1)    │
│         'modeA' → bbox aspect ratio heuristic   │
│         'modeB' → MiDaS depth estimation        │
│         'modeC' → Sobel edge projection         │
│    └→ plate count × weight → 보정된 총 무게     │
└─────────────────────────────────────────────────┘
```

### 빌드 분리 방법

`--dart-define=BUILD_VARIANT`로 Dart 컴파일 타임 상수 주입:

```dart
// camera_overlay.dart
const String kBuildVariant =
    String.fromEnvironment('BUILD_VARIANT', defaultValue: 'AC');
```

빌드할 때 applicationId와 앱 이름을 임시 변경 후 빌드 → 원복:
- APK 1: `applicationId = "com.example.v2log.testac"`, label = "V2log-AC"
- APK 2: `applicationId = "com.example.v2log.testb"`, label = "V2log-B"

### 수정/생성 파일

| 파일 | 상태 | 내용 |
|------|------|------|
| `lib/data/services/depth_estimation_service.dart` | **신규** | MiDaS TFLite 래퍼, 동적 입력 크기(256/384) 대응 |
| `lib/data/services/weight_detection_service.dart` | 수정 | Mode A/B/C 알고리즘 + 모드 전환 + DetectedPlate.estimatedPlateCount + copyWith + _PlateGeometry |
| `lib/presentation/widgets/molecules/camera_overlay.dart` | 수정 | 모드 선택 UI + BUILD_VARIANT 분기 + 모드별 상태 텍스트 |
| `assets/models/midas_v2.tflite` | **신규** | MiDaS v2.1 모델 (64MB, Mode B 전용) |

### 빌드 결과

| APK | 파일명 | 크기 | 폰 앱 이름 | 모드 버튼 |
|-----|--------|------|-----------|----------|
| APK 1 | `apk_AC.apk` | 263MB | **V2log-AC** | [OFF] [A] [C] |
| APK 2 | `apk_B.apk` | 326MB | **V2log-B** | [OFF] [B] |

- 기존 **v2log** 앱은 그대로 유지 (패키지명이 다르므로 덮어쓰지 않음)
- 3개 앱이 폰에 동시에 존재 가능

---

## 5. 측면 촬영 기술 조사 요약

### 결론
**바벨 원판 무게를 카메라로 자동 감지하는 상용 앱/서비스는 현재 존재하지 않음.**

### 원판 측면 두께 (캐스트 아이언)

| 무게 | 두께 | 직경 | 두께:직경 비율 |
|------|------|------|-------------|
| 20kg | 48~56mm | 450mm | 1:8~9 |
| 15kg | 41~48mm | 350~400mm | 1:8~10 |
| 10kg | 36~41mm | 270~310mm | 1:7~9 |
| 5kg | 23~30mm | 230~265mm | 1:9~12 |
| 2.5kg | 15~23mm | 210~215mm | 1:9~14 |

### 측면 감지가 어려운 이유
1. **극단적 종횡비**: 측면 원판 = 1:9 비율 → YOLO bbox 학습 불안정
2. **Small Object**: 640×640에서 5kg(25mm) = 5~10픽셀 너비
3. **경계 구분 어려움**: 밀착된 원판 사이 간격이 거의 없음
4. **범퍼 플레이트**: 10~25kg 직경 동일 → 두께 8mm 차이로만 구별

### 정면 vs 측면 비교

| 항목 | 정면 (현재) | 측면 |
|------|-----------|------|
| 단일 정확도 | 96.2% | 60~75% (추정) |
| 같은 무게 겹침 | **불가능** | 가능 (이론적) |
| 추가 데이터 | 0 | 1,000~3,000장 |
| 추가 개발 | 0 | 4~8주 |
| 업계 사례 | 없음 | 없음 |

### 업계 사례

| 제품 | 방식 | 무게 감지 |
|------|------|----------|
| Tempo | 3D ToF 깊이 센서 | 자체 색상 코딩 덤벨만, 바벨 미지원 |
| BarbellCV | 고대비 마커 부착 | 속도만 추적, 무게 수동 입력 |
| SpaceO | YOLO 15,000장 | 바벨 위치만, 원판 무게 미지원 |
| Motra | 가속도 센서 | 모션 패턴, 무게 수동 |

---

## 6. 장기 전략: "바깥 원판만 감지" + UX 보정

A/B/C 테스트와 별개로, **데이터 보강 + UX 개선**이 정석 해결책.

### 핵심 전략
1. AI는 **바깥에 보이는 원판만 정확하게** 감지 (이건 96% 정확)
2. 안쪽 원판은 **사용자가 ±버튼으로 추가** (1~2탭)
3. 2세트+는 **이전 무게 기억** → 대부분 같은 무게 반복

### 현재 라벨링이 잘못된 이유

현재 겹친 원판 141장: 동심원(큰 상자 안에 작은 상자) 방식으로 라벨링
→ YOLO가 "큰 동그라미=20kg"만 학습 → 10+5 겹침을 "20kg"로 착각

**새 라벨링**: 겹친 원판이면 **바깥 원판 1개만** 라벨링

### 데이터 보강 계획 (촬영 ~480장)

| 카테고리 | 조합 수 | 총 매수 |
|---------|--------|--------|
| 2장 다른 클래스 | 8종 | ~190장 |
| 3장 다른 클래스 | 3종 | ~70장 |
| 2장 같은 클래스 | 3종 | ~80장 |
| 혼합 | 2종 | ~40장 |
| 네거티브 (빈 바벨, 배경) | 3종 | ~80장 |
| **합계** | **19종** | **~480장** |

### 촬영 각도 분배 (조합당 30장)

| 각도 | 설명 | 매수 |
|------|------|------|
| 정면 0° | 바벨 끝을 카메라에 정면으로 | 8장 |
| 살짝 비틈 10~20° | 약간 기울어진 각도 | 8장 |
| 약간 비틈 20~30° | 옆면 살짝 보이는 각도 | 6장 |
| 가까이 30~50cm | 원판이 화면 50%+ 차지 | 4장 |
| 보통 거리 1~1.5m | 원판이 화면 15~30% | 4장 |

---

## 7. Sources

- MiDaS: https://github.com/isl-org/MiDaS
- MiDaS v2.1 TFLite: https://github.com/isl-org/MiDaS/releases/download/v2_1/model_opt.tflite
- Tempo: https://support.tempo.fit/support/solutions/articles/151000154718
- BarbellCV: https://github.com/tlancon/barbellcv
- SpaceO: https://www.spaceo.ai/case-study/velocity-based-training/
- YOLO Small Object: https://arxiv.org/html/2504.09900v1
- IWF Plate Specs: https://en.wikipedia.org/wiki/Weight_plate
- ChatGPT: bbox aspect ratio heuristic 제안
- Gemini: MiDaS monocular depth estimation 제안
- Genspark: Sobel edge projection + peak counting 제안
