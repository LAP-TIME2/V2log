# CV 수정노트 (Patch Notes)

> 카메라 기반 횟수 카운팅(CV Phase 1) 개발 과정에서 발생한 오류, 질문, 해결 과정을 기록.
> compact 전에 작성하여 디테일 보존.

---

## 2026-02-12 — Rep Counter v4.2 → v5.2

### 전체 흐름 요약

v2부터 v4.2까지 6번 수정했지만 "측면 90° 정지 시 오카운팅" 문제가 해결 안 됨.
→ 플랜모드로 3개 병렬 에이전트 투입하여 도메인 조사
→ 근본 원인 3가지 발견 + 업계 표준 해결책(One Euro Filter + Velocity Gate) 적용
→ v5 이후 추가 2건의 버그를 사용자 테스트로 발견하여 v5.1, v5.2로 수정

---

### [v5] One Euro Filter + Velocity Gate

**발생한 문제:**
- 측면 90° 정지 상태에서 카운트가 계속 올라감 (v2~v4.2까지 6번 수정 실패)

**내 질문:**
> "지금 같은문제로 여러번 시도 하는거 같은데 플랜모드로 각종 도메인 지식들과
> 해당분야의 전문가에 대한 데이터를 수집해서 어떻게 해야될지 플랜 모드가 다시
> 한번 계속 하고 말해줘"

**근본 원인 (왜 6번이나 실패했나):**
1. **임계값 모순**: phase 전환 임계값(6°)이 정지 감지 임계값(8°)보다 작음 → 6~8° 노이즈가 카운팅은 트리거하면서 정지 감지는 못함
2. **정지 감지 구조적 결함**: SMA 스무딩 후에도 누적 드리프트가 8°를 초과 → 정지 카운터가 매번 리셋 → 4프레임 연속 조건을 절대 못 채움
3. **시간/속도 인식 없음**: 1프레임 노이즈 스파이크와 실제 운동(20프레임 지속)을 구분 못함

**핵심 학습 — 왜 같은 틀 안에서 반복하면 안 되나:**
v2~v4.2는 전부 "SMA + amplitude 기반"이라는 같은 틀 안에서 임계값만 조정한 것.
물이 새는 배에서 양동이로 퍼내기(임계값 조정)를 계속 한 격.
실제로 필요한 건 구멍을 막는 것(필터 교체 + 속도 기반 판정).
**교훈: 같은 방식으로 2번 실패하면, 임계값 조정이 아니라 접근 방식 자체를 바꿔야 한다.**

**해결 방법:**
- **One Euro Filter** (적응형 저주파 통과 필터): 정지 시 강한 스무딩(노이즈 95%+ 제거), 운동 시 약한 스무딩(지연 1프레임 이내). Google/MediaPipe 공식 권장.
- **Velocity Gate**: "움직이는가?"를 양성 증거로 확인. 속도 ≥ 15°/sec이 2프레임 연속일 때만 카운팅 허용.

**결과:** 90° 정지 시 카운트 안 올라감 ✅

---

### [v5.1] 방향 전환 시 peak/valley 보존

**발생한 문제:**
- 세트 1은 정확한데, 세트 2~3으로 갈수록 정확도가 점점 하락

**내 질문:**
> "첫번째 세트는 진짜 측정이 잘되었거든 근데 두번째 세트 세번째 세트 할수록
> 카운트 정확도가 점점 확실하게 떨어지는데 그럴만한 요소가 있는지 체크해줘"

**근본 원인:**
운동 1회를 할 때 팔이 위→아래→위로 움직임. 방향이 바뀌는 **바로 그 순간에 속도가 0**이 됨 (물리법칙).
이때 velocity gate가 닫히면서 peak와 valley가 **같은 값으로 리셋** → 진폭(peak - valley) = 0° → 카운팅 실패!
- 세트 1이 잘 되는 이유: 체력 충분 → 방향 전환이 빠름 → 속도 0인 시간이 1프레임 이하
- 세트 2~3에서 떨어지는 이유: 피로 → 방향 전환 느려짐 → 속도 0이 2~3프레임 지속 → gate 닫힘 → peak/valley 파괴

**내 질문 (프로세스 개선):**
> "우리가 새롭게 코드를 작성하고 무엇인가를 적용할때 이런 상황이나 문제가 발생할꺼라고
> 전혀 예상 못하는거야?? 왜 작업을 두번세번 하는지 모르곘네;;"

**프로세스 개선 학습:**
예상할 수 있었음. "방향 전환점에서 속도 = 0"은 물리학 기초.
문제는 velocity gate와 direction change 감지가 **서로 어떻게 상호작용하는지** 시뮬레이션하지 않고 코드를 작성한 것.

**해결 방법:**
- "짧은 정지(방향 전환, ~0.3초)"와 "긴 정지(세트 간 휴식, 2초+)"를 구분
- 14프레임(~2초) 이상 정지해야만 peak/valley 리셋
- 방향 전환(1~2프레임)에서는 peak/valley 유지

**앞으로 적용할 규칙 — Dry-run Trace:**
상태 머신(여러 변수가 연동되는 시스템)을 만들 때, 코드 작성 전에 실제 데이터로 프레임 단위 시뮬레이션 표를 만들어 추적.
| 프레임 | 각도 | 필터 후 | 속도 | moving? | peak | valley | phase | 카운트 |
이렇게 한 줄씩 추적했으면 코드 작성 전에 버그를 발견할 수 있었음.

**결과:** 세트 간 정확도 유지 ✅

---

### [v5.2] 운동 시작 확인 시스템 (Confirmation System)

**발생한 문제:**
- 숄더프레스 시작 시 덤벨을 잡고 팔을 90°로 위치 잡으면 카운트가 항상 1 체크됨

**내 질문:**
> "이런거 안되나? 2회 이상의 연속동작에서 부터 카운트를 하는거지 그래서
> 2회 이상되었을때 이전 움직까지 카운트 해서 기록해주는거야
> 그럼 뭔가 처음에 핸드폰 셋팅하고 이동하고 하는 어쩔수 없는 움직임에서
> 발생하는 오류 카운트를 방지 할수 있을까?"

**해결 방법:**
사용자 아이디어를 그대로 구현 — **2회 연속 확인 시스템**:
1. 첫 번째 반복 감지 → 대기열에 쌓임 (UI에 0회 표시)
2. 8초 안에 두 번째 반복 감지 → "진짜 운동!" 확인 → UI에 2회 표시
3. 8초 안에 두 번째가 안 오면 → 노이즈로 판정 → 대기열 자동 초기화

**Dry-run 시뮬레이션 (코드 작성 전 검증):**
| 단계 | 행동 | 대기 중 | 확인됨? | 표시 |
|------|------|---------|---------|------|
| 1 | 덤벨 잡고 90° (노이즈) | 1개 | X | 0회 |
| 2 | 10초 대기 (폰 셋팅) | 타임아웃→0 | X | 0회 |
| 3 | 첫 번째 진짜 반복 | 1개 | X | 0회 |
| 4 | 두 번째 진짜 반복 | 2→확인! | O | 2회 |
| 5 | 세 번째~ | - | O | 3회~ |

**결과:** 준비 동작 오카운팅 방지 ✅

---

### 수정 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `lib/data/services/rep_counter_service.dart` | v4.2 → v5.2 전면 리팩토링 (One Euro Filter, Velocity Gate, Stationary Frame Count, Confirmation System) |
| `docs/02-12-10-46_CV_무게횟수_자동감지_진행상황.md` | v2~v4.2 히스토리 + v5 플랜 + 학습 포인트 추가 |

### 핵심 수치 (신호처리 기초)

| 항목 | 수치 |
|------|------|
| MediaPipe 노이즈 (raw) | ±3-5° |
| MediaPipe 노이즈 (One Euro 후) | <1° |
| 정지 시 속도 (필터 후) | <5°/sec |
| 느린 운동 (무거운 스쿼트) | ~30°/sec |
| 보통 운동 (바이셉 컬) | 60-120°/sec |
| Velocity Gate 임계값 | 15°/sec |
| 1회 운동 시간 | 0.8-5초 |
