# 다중 원판 감지 실패 — 데이터 보강 + UX 개선 종합 플랜

> 작성일: 2026-02-17 | 상태: 승인 대기

## Context: 무슨 상황이야?

원판 1개 = 100% 정확. 2개 이상 겹침 = 전부 실패.
**원인**: 학습 데이터에 겹친 원판이 제대로 없고, 라벨링도 잘못됨.
**방향**: 데이터 보강(재촬영 + 재라벨링 + 재학습) + UX 개선 병행.

---

## 핵심 전략: "바깥 원판만 감지" + UX로 나머지 보정

### 왜 이 전략인가? (전문가 4명 합의)

겹친 원판을 카메라 앞에서 보면:
- **다른 클래스 겹침** (10+5): 바깥 원판(10kg) 뒤로 안쪽 원판(5kg)의 **테두리**만 살짝 보임
- **같은 클래스 겹침** (10+10): 앞에서 보면 **1장이랑 2장이 똑같이 생김** (물리적 한계)

그래서:
1. AI는 **바깥에 보이는 원판만 정확하게** 감지 (이건 96% 정확)
2. 안쪽 원판은 **사용자가 ±버튼으로 추가** (1~2탭)
3. 2세트+는 **이전 무게 기억** → 대부분 같은 무게 반복

### 현재 라벨링이 잘못된 이유

현재 겹친 원판 141장을 **동심원(큰 상자 안에 작은 상자)** 방식으로 라벨링:
```
20kg → [=====큰 상자=====]     ← 겹침 80%+
10kg →    [==중간 상자==]       ← YOLO가 혼란
5kg  →      [작은 상자]
```
→ YOLO가 "큰 동그라미=20kg"만 학습 → 10+5 겹침을 "20kg"로 착각

**새 라벨링**: 겹친 원판이면 **바깥 원판 1개만** 라벨링:
```
20kg+10kg+5kg 겹침 사진 → 20kg bbox 1개만 라벨링 (안쪽 삭제)
10kg+5kg 겹침 사진 → 10kg bbox 1개만 라벨링
```
→ AI가 "바깥 원판 클래스"를 정확하게 학습 → 오분류(hallucination) 방지

---

## Part 1: 데이터 보강 (촬영 + 라벨링 + 재학습)

### Step 1: 기존 141장 재라벨링 (Roboflow, 2시간)

Roboflow에서 `laptimev2log/v2log-weight-plates` 프로젝트 열기:

1. 원판 2개 이상인 사진 49+58+34 = **141장** 찾기
2. 각 사진에서 **바깥(가장 큰) bbox만 남기고** 안쪽 bbox 전부 삭제
3. 예시:
   - 20kg+10kg+5kg 사진 → 20kg bbox만 남기기 (10kg, 5kg bbox 삭제)
   - 10kg+5kg 사진 → 10kg bbox만 남기기 (5kg bbox 삭제)

### Step 2: 겹친 원판 새로 촬영 (헬스장, 2~3시간)

#### 📸 촬영 조건표

| 조합 | 바깥 원판 | 라벨 | 매수 | 우선순위 |
|------|---------|------|------|---------|
| **2장 다른 클래스** | | | | |
| 20+10 | 20kg | plate_20kg | 30 | 🔴 높음 |
| 20+5 | 20kg | plate_20kg | 30 | 🔴 높음 |
| 20+15 | 20kg | plate_20kg | 20 | 🟡 중간 |
| 15+10 | 15kg | plate_15kg | 20 | 🟡 중간 |
| 15+5 | 15kg | plate_15kg | 20 | 🟡 중간 |
| 10+5 | 10kg | plate_10kg | 30 | 🔴 높음 |
| 10+2.5 | 10kg | plate_10kg | 20 | 🟡 중간 |
| 5+2.5 | 5kg | plate_5kg | 20 | 🟡 중간 |
| **3장 다른 클래스** | | | | |
| 20+10+5 | 20kg | plate_20kg | 30 | 🔴 높음 |
| 20+15+10 | 20kg | plate_20kg | 20 | 🟡 중간 |
| 15+10+5 | 15kg | plate_15kg | 20 | 🟡 중간 |
| **2장 같은 클래스** | | | | |
| 10+10 | 10kg | plate_10kg | 30 | 🔴 높음 |
| 5+5 | 5kg | plate_5kg | 30 | 🔴 높음 |
| 20+20 | 20kg | plate_20kg | 20 | 🟡 중간 |
| **혼합 (같은+다른)** | | | | |
| 20+10+10 | 20kg | plate_20kg | 20 | 🟡 중간 |
| 10+10+5 | 10kg | plate_10kg | 20 | 🟡 중간 |
| **네거티브 (오감지 방지)** | | | | |
| 빈 바벨 (원판 없음) | — | 라벨 없음 | 30 | 🔴 높음 |
| 바벨 클립만 | — | 라벨 없음 | 20 | 🟡 중간 |
| 배경 랙 원판 (멀리서) | — | 라벨 없음 | 30 | 🔴 높음 |
| **합계** | | | **~480장** | |

#### 📐 촬영 각도 (조합당 이렇게 나눠서)

**각 조합의 30장을 이렇게 분배:**

| 각도 | 설명 | 매수 | 왜? |
|------|------|------|-----|
| **정면 0°** | 바벨 끝을 카메라에 정면으로 | 8장 | 실제 앱 UX와 동일 (Stage 1) |
| **살짝 비틈 10~20°** | 원판이 약간 기울어진 각도 | 8장 | 사용자가 완벽 정면을 맞추긴 어려움 |
| **약간 비틈 20~30°** | 원판 옆면이 살짝 보임 | 6장 | 겹친 원판 테두리가 보이는 각도 |
| **가까이 30~50cm** | 원판이 화면 50%+ 차지 | 4장 | 가까이서 볼 때 |
| **보통 거리 1~1.5m** | 원판이 화면 15~30% | 4장 | 일반적 사용 거리 |

#### 📋 촬영 체크리스트 (헬스장에서 이거 보면서 촬영)

**준비물**: 스마트폰 1대 (전면 카메라 사용)

**촬영 규칙:**
1. ✅ **전면 카메라** 사용 (실제 앱과 동일)
2. ✅ **원판을 바벨에 실제로 꽂은 상태**로 촬영 (손으로 들고 있으면 안 됨)
3. ✅ **배경에 다른 원판/기구가 보여도 OK** (실제 헬스장 환경 그대로)
4. ✅ **조명 다양하게**: 밝은 쪽, 어두운 쪽, 형광등 아래 등
5. ✅ **바벨 위치 다양하게**: 벤치 랙, 스쿼트 랙, 바닥 등
6. ❌ **같은 위치에서 연속 촬영 금지** (조금씩 위치/각도 바꾸기)
7. ❌ **손이 원판을 가리면 안 됨** (촬영 후 손 빼기)

**촬영 순서 (효율적으로):**
```
1. 빈 바벨 촬영 (30장) — 네거티브 샘플
2. 10kg 1장 끼우기 → 촬영 (이미 있으므로 스킵 가능)
3. 10kg+5kg → 촬영 30장 (바깥=10kg)
4. 10kg+10kg → 촬영 30장 (바깥=10kg)
5. 5kg만 → 스킵 (이미 있음)
6. 5kg+5kg → 촬영 30장 (바깥=5kg)
7. 20kg 세팅 → 20kg+10kg, 20kg+5kg, 20kg+10+5 순서로 촬영
8. ... (표 순서대로)
9. 마지막: 배경 랙 촬영 (멀리서 30장)
```

**하나의 조합 촬영 예시 (10kg+5kg, 30장):**
```
장소: 벤치프레스 랙
  - 정면 0°, 50cm → 📸📸 (2장)
  - 정면 0°, 1m → 📸📸 (2장)
  - 비틈 15°, 50cm → 📸📸 (2장)
  - 비틈 15°, 1m → 📸📸 (2장)

장소: 스쿼트 랙으로 이동
  - 정면 0°, 50cm → 📸📸 (2장)
  - 정면 0°, 1m → 📸📸 (2장)
  - 비틈 20°, 50cm → 📸📸 (2장)
  - 비틈 20°, 1m → 📸📸 (2장)

장소: 바닥에 내려놓기
  - 정면 0°, 1m → 📸📸📸 (3장, 배경 다양하게)
  - 비틈 10°, 1m → 📸📸📸 (3장)
  - 비틈 25°, 50cm → 📸📸📸 (3장)
  - 비틈 25°, 1m → 📸📸📸 (3장)

= 30장 완료
```

### Step 3: Roboflow 업로드 + 라벨링 (2~3시간)

1. 480장 업로드
2. 각 사진에 **바깥 원판 1개만** bbox 라벨링
3. 네거티브 사진(빈 바벨, 배경)은 라벨 없이 업로드
4. Augmentation 설정:
   - Brightness: ±25%
   - Rotation: ±15°
   - Blur: 최대 2.5px
   - Noise: 최대 3%
   - ❌ 사용 금지: 큰 회전(30°+), 수직 뒤집기, Mosaic
5. Dataset v3 생성 (YOLOv8 포맷)

### Step 4: Colab 재학습 (2~4시간)

```python
from ultralytics import YOLO
model = YOLO('yolo26n.pt')
model.train(
    data='data.yaml',
    epochs=150,        # 데이터 많아졌으니 늘림
    imgsz=640,
    batch=16,
    patience=30,       # 30 에폭 동안 개선 없으면 중단
)
```

**예상 결과**:
- 바깥 원판 정확도: mAP50 90~95% (기존 96%에서 약간 하락 가능, 더 어려운 데이터이므로)
- 오분류(hallucination) 대폭 감소: 10+5→"20kg" 같은 엉뚱한 감지 사라짐

### Step 5: .tflite 변환 + 앱 전달

기존 파이프라인과 동일:
```python
model = YOLO('runs/detect/train/weights/best.pt')
model.export(format='tflite', imgsz=640, int8=False)
```
→ `assets/models/weight_plate.tflite` 교체

---

## Part 2: 코드 수정 (앱)

### 수정 1: `_deduplicateByClass` 제거

**파일**: `lib/data/services/weight_detection_service.dart`
- line 458의 `_deduplicateByClass` 호출 제거
- `_deduplicateByClass` 메서드 자체도 삭제
- 배경 방어는 기존 ROI + 크기 + 종횡비 3중 필터로 충분

### 수정 2: Quick Weight Bar (2세트+ 무게 입력)

**파일**: `lib/presentation/widgets/molecules/camera_overlay.dart`

`completedSets >= 1`이면 YOLO 모니터링 대신 **Quick Weight Bar** 표시:
```
┌─────────────────────────────────────────┐
│  이전 무게: 40.0kg                       │
│  [같은 무게]  [+2.5] [+5] [+10]         │
│  [-2.5] [-5] [-10]  [직접입력] [Re-scan] │
│  5초 후 자동 확정...                      │
└─────────────────────────────────────────┘
```

- 5초 카운트다운 → "같은 무게" 자동 확정 (현재 30초 → 5초)
- ± 버튼 탭 → 즉시 새 무게로 확정
- [Re-scan] → Stage 1 (YOLO) 복귀
- YOLO 안 돌리니까 배터리 절약

### 수정 3: Stage 1 확정 전 ±조정 버튼

**파일**: `lib/presentation/widgets/molecules/camera_overlay.dart`

안정화 3/3 도달 후 **즉시 확정 대신 3초 확인 시간** + ±버튼:
```
┌─────────────────────────────────────────┐
│  ✅ 40.0kg 감지됨                        │
│  [-10] [-5] [-2.5]  [확정]  [+2.5] [+5] [+10] │
│  3초 후 자동 확정...                      │
└─────────────────────────────────────────┘
```

- AI가 40kg 맞추면 → 3초 후 자동 확정 (편함)
- AI가 60kg 틀리면 → [-10] 탭 → 50kg으로 보정 → 즉시 확정

---

## 수정 파일 목록

| 파일 | 변경 |
|------|------|
| `lib/data/services/weight_detection_service.dart` | dedup 제거 + 새 모델 적용 |
| `lib/presentation/widgets/molecules/camera_overlay.dart` | Quick Weight Bar + ±조정 + 모니터링 교체 |
| `assets/models/weight_plate.tflite` | 재학습된 모델로 교체 |

---

## 작업 순서

| 순서 | 작업 | 누가 | 시간 |
|------|------|------|------|
| 1 | 기존 141장 재라벨링 (Roboflow) | 사용자 | 2시간 |
| 2 | 겹친 원판 480장 촬영 (헬스장) | 사용자 | 2~3시간 |
| 3 | 업로드 + 라벨링 + Augmentation | 사용자 | 2~3시간 |
| 4 | Colab 재학습 + tflite 변환 | Claude 지원 | 2~4시간 |
| 5 | 앱 코드 수정 (dedup 제거 + Quick Weight Bar) | Claude | 1~2시간 |
| 6 | 새 모델 적용 + 실기기 테스트 | 함께 | 1시간 |

---

## 검증 체크리스트

### 모델 검증
- [ ] 재학습 mAP50 ≥ 85% (바깥 원판)
- [ ] 10kg 단일 → "plate_10kg" (기존 기능 유지)
- [ ] 10+5kg 겹침 → "plate_10kg" (20kg로 오분류 안 함!)
- [ ] 10+10kg 겹침 → "plate_10kg" (hallucination 없음!)
- [ ] 빈 바벨 → 감지 없음 (false positive 0)

### 앱 검증
- [ ] Quick Weight Bar: 2세트+에서 "같은 무게" 5초 자동 확정
- [ ] Quick Weight Bar: +2.5/+5/+10 버튼 동작
- [ ] Stage 1 ±조정: 감지 후 3초 확인 시간 + ±버튼
- [ ] dedup 제거 후 배경 원판 오감지 없음 (ROI 필터 충분)

### 실기기 테스트 (헬스장)
- [ ] 10kg×1 → 40kg 감지 → 확정 (기존과 동일)
- [ ] 10+5kg → 40kg(바깥 10kg만) 감지 → 사용자 [+5] 탭 → 50kg
- [ ] 10+10kg → 40kg(바깥 10kg만) 감지 → 사용자 [+10] 탭 → 60kg
- [ ] 2세트 → Quick Weight Bar → "같은 무게" 자동 확정
