# 무게 감지 성능 최적화 분석 보고서 (2026-02-16)

## 1. 문제 요약

헬스장 실기기 테스트(Samsung Galaxy Note 20 Ultra) 결과:
- 모델이 30.0kg을 감지하긴 했지만 **안정화가 67%에서 멈춤** (3회 중 2회)
- **카메라 프레임이 극심하게 떨어져** 거의 슬라이드쇼 수준
- 1분 넘게 대기해도 안정화 완료 안 됨 → 사실상 사용 불가

---

## 2. 병목 분석 (8개 지점)

### 병목 1: YUV→RGB 변환 (L179-284)
- **소요**: 200-500ms
- **원인**: 순수 Dart 픽셀별 루프 30만 회 (width×height = 320×240 기준 76,800, 더 높으면 훨씬 많음)
- **코드**: `_convertCameraImage()` — `img.Image` 객체 생성 + `setPixelRgb()` 30만 회

### 병목 2: img.copyResize (L289)
- **소요**: 100-200ms
- **원인**: 순수 Dart bilinear 보간으로 640×640으로 리사이즈
- **코드**: `img.copyResize(image, width: 640, height: 640, interpolation: Interpolation.linear)`

### 병목 3: 텐서 생성 (L295-313)
- **소요**: 150-300ms
- **원인**: `List.generate` 4중 중첩으로 boxed double 1,228,800개 할당
- **코드**: `List.generate(1, (_) => List.generate(640, (y) => List.generate(640, (x) => [r, g, b])))`

### 병목 4: 출력 텐서 할당 (L320-326)
- **소요**: ~10ms
- **원인**: 매 프레임 `List.generate(1, (_) => List.generate(300, (_) => List.filled(6, 0.0)))` 재생성
- **코드**: `_runInference()` 내부

### 병목 5: TFLite 추론 (L328)
- **소요**: 300-800ms
- **원인**: CPU 1스레드, GPU 미사용, SIMD 미활용
- **코드**: `_interpreter!.run(input, output)` — 기본 InterpreterOptions (1 thread)

### 병목 6: 안정성 로직 오염 (L142)
- **소요**: 0ms (로직 버그)
- **원인**: `plates.isEmpty`일 때 0kg이 `_recentWeights`에 추가됨 → 실제 감지 결과와 섞여 안정화 불가
- **코드**: `_recentWeights.add(totalWeight)` — 조건 없이 항상 추가

### 병목 7: UI 스레드 블로킹
- **소요**: 전체 1-3초
- **원인**: 모든 처리(변환+리사이즈+추론)가 메인 UI 스레드에서 실행
- **결과**: 카메라 프리뷰 1-3초 멈춤 (슬라이드쇼)

### 병목 8: 메모리 압박
- **프레임당**: ~23MB 새 할당 (img.Image + resized + 4중 List + output List)
- **GC 빈도**: 매 프레임 대량 GC 발생 → 추가 프리즈

---

## 3. 해결 전략 (4단계)

### Step 1: 안정성 로직 수정 + 버퍼 사전 할당
- `plates.isNotEmpty`일 때만 `_recentWeights`에 기록
- `Float32List` 출력 텐서를 클래스 필드로 한 번만 할당하여 재사용

### Step 2: img.Image 제거 + YUV→Float32List 직접 변환
- 기존 3단계(YUV→img.Image→resize→List.generate) → 1단계(YUV→Float32List)
- nearest neighbor 리사이즈를 변환 루프에 통합
- `image` 패키지 import 제거

### Step 3: GPU Delegate + 멀티스레드
- `GpuDelegateV2` (Mali-G77 GPU, FP16) 시도
- 실패 시 `XNNPackDelegate` (ARM NEON SIMD, 4스레드) 폴백
- 최종 폴백: CPU 4스레드

### Step 4: Isolate로 전처리 분리
- `_preprocessInIsolate`를 top-level 함수로 분리
- `Isolate.run()`으로 별도 스레드에서 실행
- UI 스레드 블로킹 완전 제거

---

## 4. 성능 비교

| 단계 | 전처리 | 추론 | 합계 | UI 블로킹 | 메모리/프레임 |
|------|--------|------|------|----------|-------------|
| 최적화 전 | 500-1000ms | 300-800ms | **1-3초** | 1-3초 (프리즈) | ~23MB |
| Step 1-2 | 30-50ms | 300-800ms | 330-850ms | 330-850ms | ~4.7MB |
| Step 3 | 30-50ms | 50-200ms | **80-250ms** | 80-250ms | ~4.7MB |
| Step 4 | 30-50ms (off-thread) | 50-200ms | **80-250ms** | **~0ms** | ~4.7MB |

안정화 시간: 5프레임 스킵 × 3회 = **약 5-10초** (이전: 1분+)

---

## 5. 사용자 질문 답변

### Q1: 카메라가 0.5배율 광각인가?
**아닙니다.** 코드가 `cameras.firstWhere((c) => c.lensDirection == CameraLensDirection.front)`로 첫 번째 전면 카메라를 선택합니다. 광각을 의도적으로 선택하는 로직은 없습니다. `ResolutionPreset.low` (저해상도)라서 시야각이 넓어 보이는 것일 수 있습니다.

### Q2: 왜 프레임이 떨어지나?
모든 무거운 처리(이미지 변환 + AI 추론)가 **UI 스레드**에서 실행되기 때문입니다. 프레임 1장 처리에 1~3초 소요되는 동안 화면 렌더링이 완전히 멈춥니다.

### Q3: 왜 감지가 오래 걸리나?
5개 병목의 합산 효과 + 안정성 로직 버그(감지 실패 시 0kg 기록)가 안정화를 방해합니다.

---

## 6. 수정 파일

- `lib/data/services/weight_detection_service.dart` — **유일한 수정 파일**
- `camera_overlay.dart` — 변경 없음 (인터페이스 동일)
- `workout_screen.dart` — 변경 없음
- YOLO26-N 모델 — 재학습 불필요

---

## 7. 검증 방법

1. `flutter run -d R3CN90HVMKL` 실행
2. 콘솔 로그 확인:
   - `WeightDetectionService 초기화 완료 (GPU Delegate / XNNPack / CPU)` — 어떤 delegate 사용 중인지
   - `전처리: XXms, 추론: XXms` — 타이밍 로그
3. Stage 1에서 원판 보여주기 → 5-10초 내 안정화 확인
4. 카메라 프리뷰 부드러운지 확인 (프리즈 없음)
5. Stage 2 전환 + 횟수 카운팅 정상 동작 확인
